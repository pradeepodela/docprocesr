<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice AI ‚Äî Automated Invoice Processing</title>
  <!-- Tailwind CDN (Shadcn-like minimal design without build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class'],
      theme: {
        extend: {
          colors: {
            border: 'hsl(240 3.7% 15.9%)',
            input: 'hsl(240 3.7% 15.9%)',
            ring: 'hsl(240 4.9% 83.9%)',
            background: 'hsl(240 10% 3.9%)',
            foreground: 'hsl(0 0% 98%)',
            primary: { DEFAULT: 'hsl(251 85% 66%)', foreground: 'hsl(0 0% 100%)' },
            muted: { DEFAULT: 'hsl(240 3.7% 15.9%)', foreground: 'hsl(240 5% 64.9%)' },
            card: { DEFAULT: 'hsl(240 10% 3.9%)', foreground: 'hsl(0 0% 98%)' },
            accent: { DEFAULT: 'hsl(240 3.7% 15.9%)', foreground: 'hsl(0 0% 98%)' },
          },
          borderRadius: {
            lg: '0.75rem',
            md: '0.5rem',
            sm: '0.375rem',
          },
          boxShadow: {
            card: '0 1px 0 0 rgba(255,255,255,0.04) inset, 0 1px 2px 0 rgba(0,0,0,0.4)',
          }
        }
      }
    }
  </script>
  <style>
    /* Theme variables: light by default, override in .dark */
    :root {
      color-scheme: light;
      --background: #f7f8fa;
      --foreground: #0a0a0c;
      --border: hsl(240 6% 88%);
      --muted: hsl(240 4% 42%);
      --muted-strong: hsl(240 6% 30%);
      --muted-bg: #f0f2f5;
      --primary: hsl(251 85% 56%);
      --primary-foreground: #ffffff;
      --ring: hsl(251 85% 56% / .35);
      --card: #ffffff;
      --card-foreground: #0a0a0c;
      --elev: 0 1px 0 0 rgba(0,0,0,0.04) inset, 0 6px 16px rgba(0,0,0,0.08);
      --upload-hover: rgba(0,0,0,.03);
      --progress-track: rgba(0,0,0,.06);
      --accent: rgba(37, 99, 235, 0.08);
      --accent-strong: rgba(37, 99, 235, 0.12);
    }
    html.dark {
      color-scheme: dark;
      --background: hsl(230 15% 8%);
      --foreground: hsl(0 0% 98%);
      --border: hsl(230 10% 22%);
      --muted: hsl(230 8% 65%);
      --muted-strong: hsl(230 10% 80%);
      --muted-bg: hsl(230 12% 18% / .6);
      --primary: hsl(251 85% 66%);
      --primary-foreground: #ffffff;
      --ring: hsl(251 85% 66% / .45);
      --card: hsl(230 14% 11%);
      --card-foreground: hsl(0 0% 98%);
      --elev: 0 1px 0 0 rgba(255,255,255,0.04) inset, 0 10px 28px rgba(0,0,0,0.45);
      --upload-hover: rgba(255,255,255,.04);
      --progress-track: rgba(255,255,255,.08);
      --accent: rgba(59, 130, 246, 0.12);
      --accent-strong: rgba(59, 130, 246, 0.18);
    }

    .card { 
      background-color: var(--card);
      color: var(--card-foreground);
      border: 1px solid var(--border);
      border-radius: 0.875rem;
      box-shadow: var(--elev);
    }

    .btn { 
      display: inline-flex; align-items: center; justify-content: center;
      white-space: nowrap; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600;
      transition: transform .08s ease, color .15s ease, background .15s ease, border .15s ease, opacity .15s ease;
      outline: none; height: 2.5rem; padding: 0 .95rem;
      color: var(--foreground);
    }
    .btn:active { transform: translateY(1px) scale(0.995); }
    .btn:focus-visible { box-shadow: 0 0 0 3px var(--ring); }
    .btn-primary { background: var(--primary); color: var(--primary-foreground); }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-outline { border: 1px solid var(--border); background: linear-gradient(180deg, color-mix(in oklab, var(--muted-bg) 30%, transparent), transparent); color: var(--foreground); }
    .btn-outline:hover { background: color-mix(in oklab, var(--muted-bg) 65%, transparent); }
    .btn-ghost { border: none; background: transparent; color: var(--muted-strong); }
    .btn-ghost:hover { background: var(--muted-bg); color: var(--foreground); }

    .input { 
      display: flex; height: 2.5rem; width: 100%;
      border-radius: 0.6rem; border: 1px solid var(--border); background: color-mix(in oklab, var(--muted-bg) 30%, transparent);
      padding: 0 .85rem; font-size: .925rem; outline: none; color: var(--foreground);
      transition: box-shadow .15s ease, background .15s ease, border-color .15s ease;
    }
    .input:hover { border-color: color-mix(in oklab, var(--primary) 25%, var(--border)); }
    .input:focus { box-shadow: 0 0 0 3px var(--ring); background: transparent; }

    .switch { position: relative; display: inline-flex; height: 26px; width: 48px; border-radius: 999px; border: 1px solid var(--border); background: var(--border); transition: background .15s ease; }
    .switch-thumb { position: absolute; top: 2px; left: 2px; height: 22px; width: 22px; border-radius: 999px; background: var(--primary); transition: transform .15s ease, background .15s ease; }
    .switch[data-state="checked"] { background: color-mix(in oklab, var(--primary) 22%, transparent); }
    .switch[data-state="checked"] .switch-thumb { transform: translateX(22px); }

    .kbd { border: 1px solid var(--border); border-radius: 6px; padding: 2px 6px; font-size: 12px; color: var(--muted); background: var(--muted-bg); }
    .muted { font-size: .9rem; color: var(--muted); }

    .upload-dashed { border: 2px dashed var(--border); border-radius: 0.875rem; padding: 2.75rem; text-align: center; transition: border-color .15s ease, background .15s ease, transform .08s ease; cursor: pointer; background: linear-gradient(180deg, color-mix(in oklab, var(--muted-bg) 25%, transparent), transparent); }
    .upload-dashed:hover { border-color: color-mix(in oklab, var(--primary) 60%, transparent); background: var(--upload-hover); transform: translateY(-1px); }

    .progress-wrapper { width: 100%; background: var(--progress-track); height: 10px; border-radius: 999px; overflow: hidden; }
    .progress-bar { height: 10px; background: linear-gradient(90deg, var(--primary), color-mix(in oklab, var(--primary) 70%, #8b5cf6)); width: 0%; transition: width .2s ease; }

    /* Tiny close icon button */
    .icon-btn {
      height: 32px; width: 32px; border-radius: 8px; display: inline-grid; place-items: center;
      border: 1px solid var(--border); color: var(--muted-strong); background: transparent;
      transition: background .15s ease, color .15s ease, transform .08s ease, border-color .15s ease;
    }
    .icon-btn:hover { background: var(--muted-bg); color: var(--foreground); border-color: color-mix(in oklab, var(--primary) 25%, var(--border)); }
    .icon-btn:active { transform: translateY(1px) scale(0.98); }

    /* Pills / badges */
    .badge {
      display:inline-block; font-size:.72rem; padding:.2rem .5rem; border-radius: 999px; border:1px solid var(--border); background: color-mix(in oklab, var(--muted-bg) 35%, transparent); color: var(--muted-strong);
    }
  </style>
</head>
<body class="bg-[var(--background)] text-[var(--foreground)]">
  <div class="min-h-screen">
    <header class="sticky top-0 z-10 border-b border-[var(--border)] backdrop-blur supports-[backdrop-filter]:bg-[color-mix(in_oklab,var(--background)_70%,transparent)]">
      <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-6 w-6 bg-primary rounded grid place-items-center text-white text-xs font-bold">IA</div>
          <span class="font-semibold">Invoice AI</span>
          <span class="kbd ml-3">Minimal UI</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="muted hidden sm:block">Press Space to upload</div>
          <button id="clearBtn" class="btn btn-outline">Clear</button>
          <button id="themeIconToggle" aria-label="Toggle theme" class="btn btn-outline h-8 w-8 grid place-items-center" title="Toggle theme">
            <span id="themeIcon" class="text-lg">üåô</span>
          </button>
          <button id="themeToggle" aria-label="Toggle theme" class="switch hidden" data-state="checked">
            <span class="switch-thumb"></span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl p-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside class="lg:col-span-4 space-y-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium">Extraction Engine</div>
              <div class="muted">Choose LLM for data extraction</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-full border border-[var(--border)]">Beta</span>
          </div>
          <div class="mt-3">
            <select id="llm_choice" class="input">
              <option value="Mistral">Mistral</option>
              <option value="OpenRouter">OpenRouter</option>
            </select>
          </div>
        </div>

        <div class="card p-4">
          <div class="text-sm font-medium mb-2">Output</div>
          <label class="flex items-center gap-2 mb-2">
            <input type="checkbox" id="include_detailed_csv" class="h-4 w-4" checked />
            <span class="muted">Detailed CSV (line-level)</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="include_summary_csv" class="h-4 w-4" checked />
            <span class="muted">Summary CSV (invoice-level)</span>
          </label>
          <div class="mt-4">
            <div class="text-sm font-medium">Confidence threshold</div>
            <div class="muted">Flag low-confidence fields</div>
            <input id="confidenceThreshold" type="range" min="0.5" max="0.99" step="0.01" value="0.85" class="w-full mt-2"/>
          </div>
        </div>

        <div class="card p-4">
          <details>
            <summary class="cursor-pointer text-sm font-medium">CSV Columns Overview</summary>
            <div class="muted mt-2 text-xs">
              file_number, invoice_number, invoice_date, vendor_name, customer_name, line_item_number,
              item_description, quantity, unit_price, line_total, subtotal, tax_amount, total_amount
            </div>
          </details>
        </div>

        <div class="muted text-xs px-1">Tip: Press <span class="kbd">Space</span> to open file picker</div>
      </aside>

      <!-- Main -->
      <section class="lg:col-span-8 space-y-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">Bulk Invoice to CSV</div>
              <div class="muted">Upload invoices. We'll OCR, extract, and structure.</div>
            </div>
            <span class="badge">Ready</span>
          </div>

          <div class="mt-4">
            <div id="uploadArea" class="upload-dashed" role="button" tabindex="0" aria-label="Upload invoices. Click to browse or drag & drop.">
              <div class="text-5xl mb-2">‚òÅÔ∏è</div>
              <h3 class="text-lg font-medium">Drag & Drop invoices here</h3>
              <p class="muted">or click to browse ‚Äî PDF, JPG, PNG ‚Äî max 20 files</p>
              <button id="browseBtn" type="button" class="btn btn-outline mt-2">Browse files‚Ä¶</button>
              <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">
            </div>

            <div id="fileList" class="mt-3"></div>

            <div class="flex flex-wrap items-center gap-2 mt-3">
              <button id="processBtn" class="btn btn-primary" disabled>Process All</button>
              <button id="sampleBtn" class="btn btn-outline">Try Sample</button>
            </div>
          </div>
        </div>

        <!-- Processing -->
        <div class="card p-4 hidden" id="processingCard">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Processing Invoices</h3>
            <span class="badge">Live</span>
          </div>
          <div class="progress-wrapper mt-3">
            <div id="progressBar" class="progress-bar"></div>
          </div>
          <div class="flex items-center justify-between mt-2 text-sm">
            <span id="processingStatus" class="muted">Initializing...</span>
            <span id="progressMeta" class="muted"></span>
          </div>
        </div>

        <!-- Results - Review & Approve -->
        <div class="card p-4 hidden" id="resultsCard">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-medium">Review & Approve</h3>
            <div class="flex gap-2">
              <button class="btn btn-outline" id="downloadDetailed">Detailed CSV</button>
              <button class="btn btn-outline" id="downloadSummary">Summary CSV</button>
              <button class="btn btn-outline" id="downloadJson">Raw JSON</button>
              <button class="btn btn-primary" id="openExportWizard" title="Custom schema exports">Export‚Ä¶</button>
            </div>
          </div>

          <!-- Compact rows of files -->
          <div id="reviewRows" class="space-y-2"></div>
        </div>

        <!-- Export Wizard Modal -->
        <div id="exportWizard" class="fixed inset-0 z-50 hidden">
          <div class="absolute inset-0 bg-black/50" id="exportWizardBackdrop"></div>
          <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(900px,95vw)] max-h-[85vh] overflow-auto bg-[var(--background)] border border-[var(--border)] rounded-xl">
            <div class="flex items-center justify-between p-3 border-b border-[var(--border)]">
              <div class="font-semibold">Custom Schema Mapping</div>
              <button id="exportWizardClose" class="icon-btn" title="Close" aria-label="Close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </button>
            </div>

            <div class="p-3">
              <div class="muted text-xs mb-2">Design two schemas and export as separate CSVs: Header.csv and LineItems.csv</div>

              <!-- Preset controls -->
              <div class="flex flex-wrap gap-2 items-end mb-3">
                <div>
                  <label class="muted text-xs">Preset name</label>
                  <input id="presetName" class="input w-[220px]" placeholder="e.g. QuickBooks Bills v1">
                </div>
                <button class="btn btn-outline" id="savePreset">Save Preset</button>
                <select id="loadPresetSelect" class="input w-[220px]">
                  <option value="">Load preset‚Ä¶</option>
                </select>
                <button class="btn btn-outline" id="deletePreset">Delete Preset</button>
              </div>

              <!-- Tabs -->
              <div class="flex gap-2 mb-3">
                <button id="tabHeader" class="btn btn-outline">Header schema</button>
                <button id="tabLines" class="btn btn-outline">Line items schema</button>
                <div class="grow"></div>
                <button class="btn btn-primary" id="exportHeader">Download Header.csv</button>
                <button class="btn btn-primary" id="exportLines">Download LineItems.csv</button>
              </div>

              <!-- Header schema designer -->
              <div id="headerSchemaPane" class="card p-3 mb-3">
                <div class="flex items-center justify-between mb-2">
                  <div class="font-medium">Header Columns</div>
                  <button class="btn btn-outline text-xs" id="addHeaderCol">+ Add column</button>
                </div>
                <div class="muted text-xs mb-2">Common sources: vendor_name, invoice_number, invoice_date, subtotal, tax_amount, total_amount, customer_name, confidence_threshold</div>
                <div id="headerCols" class="space-y-2"></div>
              </div>

              <!-- Line items schema designer -->
              <div id="linesSchemaPane" class="card p-3">
                <div class="flex items-center justify-between mb-2">
                  <div class="font-medium">Line Items Columns</div>
                  <button class="btn btn-outline text-xs" id="addLineCol">+ Add column</button>
                </div>
                <div class="muted text-xs mb-2">Common sources: line_items[].description, line_items[].quantity, line_items[].unit_price, line_items[].total_price. You can also pull header fields.</div>
                <div id="lineCols" class="space-y-2"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Slide-over Drawer -->
        <div id="drawer" class="fixed inset-0 z-50 hidden">
          <div class="absolute inset-0 bg-black/50" id="drawerBackdrop"></div>
          <div class="absolute right-0 top-0 h-full w-full max-w-5xl bg-[var(--background)] border-l border-[var(--border)] overflow-y-auto">
            <div class="flex items-center justify-between p-3 border-b border-[var(--border)]">
              <div class="font-medium">Invoice Review</div>
              <button id="drawerClose" class="btn btn-outline">Close</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
              <!-- Left: Form -->
              <div class="p-4 border-r border-[var(--border)]">
                <form id="invoiceForm" class="space-y-4">
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="muted text-xs">Invoice Number</label>
                      <input class="input" name="invoice_number" placeholder="e.g. INV-1001"/>
                    </div>
                    <div>
                      <label class="muted text-xs">Invoice Date</label>
                      <input class="input" name="invoice_date" type="date"/>
                    </div>
                    <div>
                      <label class="muted text-xs">Vendor Name</label>
                      <input class="input" name="vendor_name" placeholder="Vendor Inc."/>
                    </div>
                    <div>
                      <label class="muted text-xs">Customer Name</label>
                      <input class="input" name="customer_name" placeholder="Customer LLC"/>
                    </div>
                  </div>
                  <div class="grid grid-cols-3 gap-3">
                    <div>
                      <label class="muted text-xs">Subtotal</label>
                      <div class="flex items-center gap-2">
                        <span class="muted text-xs">$</span>
                        <input class="input" name="subtotal" type="number" step="0.01" placeholder="0.00"/>
                      </div>
                    </div>
                    <div>
                      <label class="muted text-xs">Tax Amount</label>
                      <div class="flex items-center gap-2">
                        <span class="muted text-xs">$</span>
                        <input class="input" name="tax_amount" type="number" step="0.01" placeholder="0.00"/>
                      </div>
                    </div>
                    <div>
                      <label class="muted text-xs">Total Amount</label>
                      <div class="flex items-center gap-2">
                        <span class="muted text-xs">$</span>
                        <input class="input" name="total_amount" type="number" step="0.01" placeholder="0.00"/>
                      </div>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="text-sm font-medium">Line Items</div>
                        <div class="muted text-xs">Description, Qty, Unit Price, Total</div>
                      </div>
                      <button type="button" class="btn btn-outline text-xs" id="addLineItem">+ Add item</button>
                    </div>

                    <!-- Line items header -->
                    <div class="grid grid-cols-12 gap-2 text-xs muted">
                      <div class="col-span-6">Description</div>
                      <div class="col-span-2 text-right">Qty</div>
                      <div class="col-span-2 text-right">Unit Price</div>
                      <div class="col-span-2 text-right">Total</div>
                    </div>

                    <div id="lineItems" class="space-y-2"></div>
                  </div>

                  <div class="flex justify-end gap-2 pt-2">
                    <button type="button" class="btn btn-outline" id="saveDraftBtn">Save Draft</button>
                    <button type="button" class="btn btn-primary" id="approveBtn">Approve</button>
                  </div>
                </form>
              </div>

              <!-- Right: Preview -->
              <div class="p-4">
                <div class="muted text-xs mb-1">Preview</div>
                <div id="previewContainer" class="border border-[var(--border)] rounded-md p-2 min-h-[400px] grid place-items-center overflow-hidden">
                  <div class="muted">No preview</div>
                </div>
                <div class="muted text-xs mt-2" id="previewHelp" hidden>
                  No preview available. For images, previews are auto-saved; for PDFs, consider enabling preview generation.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // State
    let selectedFiles = [];
    let processingResults = null;

    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const processBtn = document.getElementById('processBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const processingCard = document.getElementById('processingCard');
    const resultsCard = document.getElementById('resultsCard');
    const progressBar = document.getElementById('progressBar');
    const processingStatus = document.getElementById('processingStatus');
    const progressMeta = document.getElementById('progressMeta');

    // Theme toggle
    // Theme toggle (icon-based)
    const themeIconToggle = document.getElementById('themeIconToggle');
    const themeIcon = document.getElementById('themeIcon');
    const storedTheme = localStorage.getItem('theme') || 'dark';
    let dark = storedTheme === 'dark';
    document.documentElement.classList.toggle('dark', dark);
    updateThemeIcon();

    themeIconToggle.addEventListener('click', () => {
      dark = !dark;
      document.documentElement.classList.toggle('dark', dark);
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      updateThemeIcon();
    });

    function updateThemeIcon() {
      themeIcon.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
      themeIconToggle.title = dark ? 'Switch to light theme' : 'Switch to dark theme';
    }

    // File input change handler
    function handleFileSelection(files) {
      const fileArray = Array.from(files);
      const validFiles = fileArray.filter(f => {
        const ext = f.name.toLowerCase().split('.').pop();
        return ['pdf', 'jpg', 'jpeg', 'png'].includes(ext);
      });
      
      if (validFiles.length === 0) {
        showErrors(['No supported files found. Please select PDF, JPG, JPEG, or PNG files.']);
        return;
      }
      
      // Add new files to existing selection (up to 20 total)
      selectedFiles = [...selectedFiles, ...validFiles].slice(0, 20);
      renderFileList();
      processBtn.disabled = selectedFiles.length === 0;
      
      if (validFiles.length !== fileArray.length) {
        showErrors([`${fileArray.length - validFiles.length} file(s) were skipped (unsupported format)`]);
      }
    }

    // File input event listeners
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length > 0) {
        handleFileSelection(e.target.files);
      }
      // Reset input value to allow selecting same files again
      e.target.value = '';
    });

    // Upload area click handler
    uploadArea.addEventListener('click', (e) => {
      // Prevent triggering when clicking the browse button specifically
      if (e.target.id !== 'browseBtn') {
        fileInput.click();
      }
    });

    // Browse button click handler
    document.getElementById('browseBtn').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      fileInput.click();
    });

    // Keyboard accessibility
    uploadArea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('ring-2', 'ring-primary');
    });

    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      // Only remove highlight if we're actually leaving the upload area
      if (!uploadArea.contains(e.relatedTarget)) {
        uploadArea.classList.remove('ring-2', 'ring-primary');
      }
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('ring-2', 'ring-primary');
      
      const files = e.dataTransfer.files;
      if (files && files.length > 0) {
        handleFileSelection(files);
      }
    });

    function renderFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
      }

      const items = selectedFiles.map((file, index) => {
        const size = (file.size / (1024 * 1024)).toFixed(2);
        const safeName = file.name.replace(/[&<>"']/g, (c) => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[c]));
        
        return `
          <div class="flex items-center justify-between border border-[var(--border)] rounded-md p-2 mb-2">
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-md" style="background: var(--muted-bg); color: var(--foreground); display:grid;place-items:center;">üìÑ</div>
              <div>
                <div class="text-sm font-medium">${safeName}</div>
                <div class="muted text-xs">${size} MB</div>
              </div>
            </div>
            <button class="icon-btn" aria-label="Remove file" title="Remove" data-remove-index="${index}">
              <!-- Cross icon -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        `;
      }).join('');
      
      fileList.innerHTML = items;
      
      // Add remove button event listeners
      fileList.querySelectorAll('[data-remove-index]').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-remove-index'));
          selectedFiles.splice(index, 1);
          renderFileList();
          processBtn.disabled = selectedFiles.length === 0;
        });
      });
    }

    // Keyboard shortcut: Space to open picker
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && document.activeElement === document.body) {
        e.preventDefault();
        fileInput.click();
      }
    });

    // Clear button
    document.getElementById('clearBtn').addEventListener('click', () => {
      selectedFiles = [];
      renderFileList();
      processBtn.disabled = true;
      processingCard.classList.add('hidden');
      resultsCard.classList.add('hidden');
      // Clear any error messages
      document.querySelectorAll('.error-message').forEach(el => el.remove());
    });

    // Sample button now calls backend with a bundled sample hosted in public/ if any,
    // otherwise falls back to showing a note to upload real files.
    sampleBtn.addEventListener('click', async () => {
      try {
        // Attempt to fetch a sample from backend (optional future endpoint)
        // For now, instruct user to upload a real file since backend returns real CSV.
        showErrors(['No built-in sample data. Please upload a PDF/JPG/PNG to generate real CSV previews.']);
      } catch (e) {
        showErrors(['Sample run unavailable. Upload a real invoice instead.']);
      }
    });

    // Process button
    processBtn.addEventListener('click', processFiles);

    async function processFiles() {
      if (selectedFiles.length === 0) {
        showErrors(['Please select at least one file.']);
        return;
      }

      processingCard.classList.remove('hidden');
      resultsCard.classList.add('hidden');
      simulateProgress();

      // Build FormData to send to Flask backend
      const formData = new FormData();
      selectedFiles.forEach(file => formData.append('files', file));
      formData.append('llm_choice', document.getElementById('llm_choice').value);
      formData.append('include_detailed_csv', document.getElementById('include_detailed_csv').checked ? 'on' : '');
      formData.append('include_summary_csv', document.getElementById('include_summary_csv').checked ? 'on' : '');
      const conf = document.getElementById('confidenceThreshold')?.value;
      if (conf) formData.append('confidence_threshold', conf);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        // Handle non-2xx with JSON error body or generic message
        let result;
        try {
          result = await response.json();
        } catch {
          throw new Error(`Unexpected response (${response.status})`);
        }

        if (response.ok && result?.success) {
          processingResults = result;
          displayResults(result);
        } else {
          const errs = result?.errors?.length ? result.errors : [`Upload failed (${response.status}).`];
          showErrors(errs);
          processingCard.classList.add('hidden');
        }
      } catch (err) {
        showErrors([`Network error: ${err.message}`]);
        processingCard.classList.add('hidden');
      }
    }

    // Progress simulation
    function updateProgress(percent, message) {
      progressBar.style.width = Math.min(percent, 100) + '%';
      processingStatus.textContent = message;
      progressMeta.textContent = `${Math.round(Math.min(percent, 100))}%`;
    }

    function simulateProgress() {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 12 + 3;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          updateProgress(progress, 'Processing complete!');
        } else {
          updateProgress(progress, `Processing invoices... ${Math.round(progress)}%`);
        }
      }, 400);
    }

    // Results display
    function displayResults(result) {
      processingCard.classList.add('hidden');
      resultsCard.classList.remove('hidden');
      processingResults = withApprovalState(result);
      renderReviewRows();
      setupDownloadButtons(processingResults);
      // Optionally show any backend errors
      if (processingResults.errors && processingResults.errors.length > 0) {
        showErrors(processingResults.errors);
      }
    }

    function setupDownloadButtons(result) {
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');

      // Recompute CSVs from current edited state before download
      document.getElementById('downloadDetailed').onclick = () => {
        const csv = buildDetailedCSV(result.invoices);
        downloadCSV(csv, `invoices_detailed_${timestamp}.csv`);
      };
      document.getElementById('downloadSummary').onclick = () => {
        const csv = buildSummaryCSV(result.invoices);
        downloadCSV(csv, `invoices_summary_${timestamp}.csv`);
      };
      document.getElementById('downloadJson').onclick = () => {
        const jsonData = JSON.stringify(result.invoices, null, 2);
        downloadJSON(jsonData, `invoices_raw_${timestamp}.json`);
      };

      // Export Wizard
      const exportBtn = document.getElementById('openExportWizard');
      if (exportBtn) {
        exportBtn.onclick = () => openExportWizard(processingResults);
      }
    }

    function downloadCSV(csvContent, filename) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function downloadJSON(jsonContent, filename) {
      const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Build compact rows UI
    function renderReviewRows() {
      const rows = document.getElementById('reviewRows');
      const invoices = processingResults.invoices || [];
      rows.innerHTML = invoices.map((inv, idx) => {
        const fname = inv.source_file || `Invoice ${idx + 1}`;
        const approved = inv.__approved ? 'Approved' : 'Pending';
        return `
          <div class="flex items-center justify-between border border-border rounded-md px-3 py-2">
            <div class="flex items-center gap-3">
              <div class="h-6 w-6 rounded bg-muted grid place-items-center">üìÑ</div>
              <div>
                <div class="text-sm font-medium">${fname}</div>
                <div class="muted text-xs">${inv.invoice_number || 'N/A'} ‚Äî ${inv.vendor_name || 'N/A'}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="badge">${approved}</span>
              <button class="btn btn-outline text-xs" data-view="${idx}">View</button>
              <button class="btn btn-primary text-xs" data-approve="${idx}">Approve</button>
            </div>
          </div>
        `;
      }).join('');

      // Bind actions
      rows.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => openDrawer(parseInt(btn.getAttribute('data-view'))));
      });
      rows.querySelectorAll('[data-approve]').forEach(btn => {
        btn.addEventListener('click', () => approveInvoice(parseInt(btn.getAttribute('data-approve'))));
      });
    }

    // Drawer state and helpers
    let activeIndex = null;

    function openDrawer(index) {
      activeIndex = index;
      const inv = processingResults.invoices[index];
      // Populate form
      const form = document.getElementById('invoiceForm');
      setInputValue(form, 'invoice_number', inv.invoice_number || '');
      setInputValue(form, 'invoice_date', (inv.invoice_date || '').slice(0,10));
      setInputValue(form, 'vendor_name', inv.vendor_name || '');
      setInputValue(form, 'customer_name', inv.customer_name || '');
      setInputValue(form, 'subtotal', safeNum(inv.subtotal));
      setInputValue(form, 'tax_amount', safeNum(inv.tax_amount));
      setInputValue(form, 'total_amount', safeNum(inv.total_amount));
      renderLineItems(inv.line_items || []);

      // Preview on right: try image first, then PDF viewer fallback, then /public path, then unavailable
      const preview = document.getElementById('previewContainer');
      preview.innerHTML = '';

      const url = typeof inv.preview_url === 'string' ? inv.preview_url : '';
      const sourceFile = inv.source_file || '';

      // Helper: create image element
      function renderImage(src) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Preview';
        img.className = 'max-h-[80vh] object-contain';
        img.onerror = () => tryPdfFallback();
        preview.appendChild(img);
      }

      // Helper: create PDF iframe
      function renderPdf(src) {
        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.title = 'PDF Preview';
        iframe.className = 'w-full h-[80vh] border-0';
        iframe.onload = () => {/* loaded */};
        iframe.onerror = () => previewUnavailable();
        preview.appendChild(iframe);
      }

      function tryPdfFallback() {
        // If we have a data: application/pdf or a file that ends with .pdf, embed it
        if (url && (url.startsWith('data:application/pdf') || url.toLowerCase().endsWith('.pdf'))) {
          return renderPdf(url);
        }
        if (sourceFile && sourceFile.toLowerCase().endsWith('.pdf')) {
          // Let browser handle via /uploads or /public if available
          // Try /uploads/<filename> then /public/previews/<filename>.pdf
          const fname = sourceFile.split('/').pop();
          const guess1 = `/uploads/${fname}`;
          const guess2 = `/public/previews/${fname}`;
          // Use first; if it fails user will still see unavailable message
          return renderPdf(guess1);
        }
        previewUnavailable();
      }

      if (url) {
        // 1) If it's an image data URL or ends with common image types -> show image
        if (url.startsWith('data:image') || /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(url)) {
          renderImage(url);
        }
        // 2) If it's a PDF data URL or ends with .pdf -> embed PDF
        else if (url.startsWith('data:application/pdf') || url.toLowerCase().endsWith('.pdf')) {
          renderPdf(url);
        }
        // 3) If it points to a persisted public path, try to infer type and render
        else if (url.startsWith('/public/') || url.startsWith('/uploads/')) {
          if (/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(url)) {
            renderImage(url);
          } else if (url.toLowerCase().endsWith('.pdf')) {
            renderPdf(url);
          } else {
            // Unknown extension; try image first then PDF
            renderImage(url);
          }
        } else {
          // Unknown schema; try image first then PDF fallback
          renderImage(url);
        }
      } else {
        // No preview_url; try to guess from original source file name
        if (sourceFile) {
          const fname = sourceFile.split('/').pop();
          const lower = fname.toLowerCase();
          if (/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(lower)) {
            // Common placement: /uploads or /public/previews
            renderImage(`/uploads/${fname}`);
          } else if (lower.endsWith('.pdf')) {
            renderPdf(`/uploads/${fname}`);
          } else {
            previewUnavailable();
          }
        } else {
          previewUnavailable();
        }
      }

      function previewUnavailable() {
        preview.innerHTML = '<div class="muted">No preview available for this file.</div>';
        const help = document.getElementById('previewHelp');
        if (help) help.hidden = false;
      }

      document.getElementById('drawer').classList.remove('hidden');
    }

    function closeDrawer() {
      document.getElementById('drawer').classList.add('hidden');
      activeIndex = null;
    }

    document.getElementById('drawerClose').addEventListener('click', closeDrawer);
    document.getElementById('drawerBackdrop').addEventListener('click', closeDrawer);

    function setInputValue(form, name, value) {
      const el = form.querySelector(`[name="${name}"]`);
      if (el) el.value = value ?? '';
    }

    function safeNum(v) {
      const n = parseFloat(v);
      return isNaN(n) ? '' : n;
    }

    // Line items UI
    function renderLineItems(items) {
      const container = document.getElementById('lineItems');
      container.innerHTML = items.map((it, i) => lineItemRowTemplate(i, it)).join('');
      bindLineItemsEvents();
    }

    function lineItemRowTemplate(i, it) {
      const q = Number(it.quantity ?? 0);
      const up = Number(it.unit_price ?? 0);
      const tpCalc = Number((q * up).toFixed(2));
      const tp = Number(isFinite(it.total_price) ? it.total_price : tpCalc);

      return `
        <div class="grid grid-cols-12 gap-2 items-center border border-[var(--border)] rounded-md p-2" data-index="${i}">
          <input class="input col-span-6" placeholder="e.g. Item or Service" name="description" value="${escapeHTML(it.description || '')}"/>
          <input class="input col-span-2 text-right" placeholder="0" name="quantity" type="number" step="0.01" value="${isFinite(q)?q:''}"/>
          <div class="col-span-2 flex items-center gap-1">
            <span class="muted text-xs">$</span>
            <input class="input text-right w-full" placeholder="0.00" name="unit_price" type="number" step="0.01" value="${isFinite(up)?up:''}"/>
          </div>
          <div class="col-span-2 flex items-center gap-1">
            <span class="muted text-xs">$</span>
            <input class="input text-right w-full" placeholder="0.00" name="total_price" type="number" step="0.01" value="${isFinite(tp)?tp:''}"/>
          </div>
          <div class="col-span-12 flex justify-end">
            <button type="button" class="icon-btn mt-2" aria-label="Remove line item" title="Remove" data-remove="${i}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function bindLineItemsEvents() {
      const container = document.getElementById('lineItems');

      // Auto-calc total when qty or unit price changes
      container.querySelectorAll('input[name="quantity"], input[name="unit_price"]').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const row = e.target.closest('[data-index]');
          const q = toNum(row.querySelector('[name="quantity"]').value);
          const up = toNum(row.querySelector('[name="unit_price"]').value);
          row.querySelector('[name="total_price"]').value = (q * up).toFixed(2);
        });
      });

      // Remove buttons
      container.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const row = btn.closest('[data-index]');
          row?.remove();
          // Reindex
          Array.from(container.children).forEach((r, i) => r.setAttribute('data-index', i));
        });
      });
    }

    document.getElementById('addLineItem').addEventListener('click', () => {
      const container = document.getElementById('lineItems');
      const i = container.children.length;
      container.insertAdjacentHTML('beforeend', lineItemRowTemplate(i, { description: '', quantity: '', unit_price: '', total_price: '' }));
      bindLineItemsEvents();
    });

    // Save Draft & Approve
    document.getElementById('saveDraftBtn').addEventListener('click', () => persistEdits(false));
    document.getElementById('approveBtn').addEventListener('click', () => persistEdits(true));

    function persistEdits(markApprove) {
      if (activeIndex == null) return;
      const form = document.getElementById('invoiceForm');
      const inv = processingResults.invoices[activeIndex];

      inv.invoice_number = form.querySelector('[name="invoice_number"]').value.trim();
      inv.invoice_date = form.querySelector('[name="invoice_date"]').value;
      inv.vendor_name = form.querySelector('[name="vendor_name"]').value.trim();
      inv.customer_name = form.querySelector('[name="customer_name"]').value.trim();
      inv.subtotal = toNum(form.querySelector('[name="subtotal"]').value);
      inv.tax_amount = toNum(form.querySelector('[name="tax_amount"]').value);
      inv.total_amount = toNum(form.querySelector('[name="total_amount"]').value);

      // Collect line items
      const rows = Array.from(document.getElementById('lineItems').children);
      inv.line_items = rows.map(row => {
        const q = toNum(row.querySelector('[name="quantity"]').value);
        const up = toNum(row.querySelector('[name="unit_price"]').value);
        let tp = toNum(row.querySelector('[name="total_price"]').value);
        if (!isFinite(tp) || tp === 0) tp = Number((q * up).toFixed(2));
        return {
          description: row.querySelector('[name="description"]').value.trim(),
          quantity: q,
          unit_price: up,
          total_price: tp
        };
      });

      if (markApprove) inv.__approved = true;

      // Recompute summary stats on client if needed (optional to display)
      processingResults.stats = recomputeStats(processingResults.invoices);

      renderReviewRows();
      closeDrawer();
    }

    function toNum(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&','<':'<','>':'>','"':'"',"'":'&#39;'}[c]));
    }

    function withApprovalState(result) {
      const r = JSON.parse(JSON.stringify(result || {}));
      (r.invoices || []).forEach(inv => {
        if (typeof inv.__approved !== 'boolean') inv.__approved = false;
      });
      return r;
    }

    function recomputeStats(invoices) {
      const totalInvoices = invoices.length;
      const totalLineItems = invoices.reduce((acc, inv) => acc + (Array.isArray(inv.line_items) ? inv.line_items.length : 0), 0);
      const totalAmount = invoices.reduce((acc, inv) => acc + (Number(inv.total_amount) || 0), 0);
      const averageAmount = totalInvoices ? totalAmount / totalInvoices : 0;
      return { total_invoices: totalInvoices, total_line_items: totalLineItems, total_amount: totalAmount, average_amount: averageAmount };
    }

    // Approve directly from row (without opening drawer)
    function approveInvoice(index) {
      activeIndex = index;
      persistEdits(true); // if drawer not opened, no edits; just mark approved
    }

    // CSV builders from current state
    function buildDetailedCSV(invoices) {
      const header = 'file_number,invoice_number,vendor_name,customer_name,item_description,quantity,unit_price,line_total';
      const lines = [header];
      let fileNum = 1;
      invoices.forEach(inv => {
        const items = Array.isArray(inv.line_items) ? inv.line_items : [];
        items.forEach(li => {
          lines.push([
            fileNum,
            quote(inv.invoice_number),
            quote(inv.vendor_name),
            quote(inv.customer_name),
            quote(li.description),
            Number(li.quantity || 0),
            Number(li.unit_price || 0),
            Number(li.total_price || 0)
          ].join(','));
        });
        fileNum += 1;
      });
      return lines.join('\n');
    }

    function buildSummaryCSV(invoices) {
      const header = 'file_number,invoice_number,invoice_date,vendor_name,customer_name,items,total';
      const lines = [header];
      let fileNum = 1;
      invoices.forEach(inv => {
        const itemCount = Array.isArray(inv.line_items) ? inv.line_items.length : 0;
        lines.push([
          fileNum,
          quote(inv.invoice_number),
          quote(inv.invoice_date),
          quote(inv.vendor_name),
          quote(inv.customer_name),
          itemCount,
          Number(inv.total_amount || 0)
        ].join(','));
        fileNum += 1;
      });
      return lines.join('\n');
    }

    function quote(v) {
      const s = v == null ? '' : String(v);
      if (s.includes(',') || s.includes('"') || s.includes('\n')) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }

    function showInvoiceDetails(invoices) {
      const details = document.getElementById('invoiceDetails');
      let html = '';
      
      invoices.forEach((invoice, index) => {
        const total = (invoice.total_amount || 0).toFixed(2);
        const status = (invoice.total_amount || 0) > 0 ? 'Processed' : 'Needs Review';
        
        html += `
          <div class="border border-border rounded-md p-3 mb-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="muted text-xs">Invoice ${index + 1}</div>
                <div class="font-medium">${invoice.invoice_number || 'N/A'} ‚Äî ${invoice.vendor_name || 'N/A'}</div>
              </div>
              <div class="text-right">
                <span class="text-xs px-2 py-1 rounded-full border border-border">${status}</span>
                <div class="mt-2 font-semibold">${total}</div>
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-3 mt-3">
              <div class="border border-[var(--border)] rounded-md p-2">
                <div class="muted text-xs">Invoice Info</div>
                <div class="text-sm mt-1">
                  <div><strong>Number:</strong> ${invoice.invoice_number || 'N/A'}</div>
                  <div><strong>Date:</strong> ${invoice.invoice_date || 'N/A'}</div>
                  <div><strong>Vendor:</strong> ${invoice.vendor_name || 'N/A'}</div>
                  <div><strong>Customer:</strong> ${invoice.customer_name || 'N/A'}</div>
                </div>
              </div>
              <div class="border border-border rounded-md p-2">
                <div class="muted text-xs">Line Items</div>
                <div class="text-sm mt-1">
                  ${(invoice.line_items || []).length > 0
                    ? invoice.line_items.map((item, idx) =>
                        `<div class="flex items-center justify-between mb-1">
                          <span>${idx + 1}. ${item.description || 'N/A'}</span>
                          <span>Qty: ${item.quantity || 0} ‚Äî ${(item.total_price || 0).toFixed(2)}</span>
                        </div>`
                      ).join('')
                    : '<div>No line items found</div>'
                  }
                </div>
              </div>
            </div>
          </div>`;
      });
      
      details.innerHTML = html;
    }

    function showErrors(errors) {
      const messages = Array.isArray(errors) ? errors : [String(errors || 'Unknown error')];
      const errorHtml = messages.map(error => 
        `<div class="error-message border border-red-500/35 bg-red-500/12 text-red-200 text-sm rounded-md p-3 mb-3">
          ‚ö†Ô∏è ${error}
        </div>`
      ).join('');
      
      // Find the main upload card and prepend errors
      const uploadCard = document.querySelector('.card');
      uploadCard.insertAdjacentHTML('afterbegin', errorHtml);
      
      // Auto-remove errors after 5 seconds
      setTimeout(() => {
        document.querySelectorAll('.error-message').forEach(el => el.remove());
      }, 5000);
    }

    // Export Wizard Logic
    const PRESETS_KEY = 'custom_export_presets_v1';

    function openExportWizard(state) {
      const modal = document.getElementById('exportWizard');
      modal.classList.remove('hidden');
      // Initialize tabs, lists, and load presets
      initWizardUI();
      loadPresets();
      // Seed default columns if empty
      if (document.getElementById('headerCols').children.length === 0) {
        addHeaderCol({ name: 'Vendor', path: 'vendor_name', tf: 'none', fmt: '' });
        addHeaderCol({ name: 'Invoice Number', path: 'invoice_number', tf: 'none', fmt: '' });
        addHeaderCol({ name: 'Invoice Date', path: 'invoice_date', tf: 'date', fmt: 'YYYY-MM-DD' });
        addHeaderCol({ name: 'Customer', path: 'customer_name', tf: 'none', fmt: '' });
        addHeaderCol({ name: 'Subtotal', path: 'subtotal', tf: 'number', fmt: '2' });
        addHeaderCol({ name: 'Tax', path: 'tax_amount', tf: 'number', fmt: '2' });
        addHeaderCol({ name: 'Total', path: 'total_amount', tf: 'number', fmt: '2' });
      }
      if (document.getElementById('lineCols').children.length === 0) {
        addLineCol({ name: 'File #', path: '$index', tf: 'none', fmt: '' });
        addLineCol({ name: 'Description', path: 'line_items[].description', tf: 'none', fmt: '' });
        addLineCol({ name: 'Qty', path: 'line_items[].quantity', tf: 'number', fmt: '2' });
        addLineCol({ name: 'Unit Price', path: 'line_items[].unit_price', tf: 'number', fmt: '2' });
        addLineCol({ name: 'Line Total', path: 'line_items[].total_price', tf: 'number', fmt: '2' });
        addLineCol({ name: 'Invoice #', path: 'invoice_number', tf: 'none', fmt: '' });
      }

      // Bind close
      document.getElementById('exportWizardBackdrop').onclick = closeExportWizard;
      document.getElementById('exportWizardClose').onclick = closeExportWizard;

      // Tabs
      const tabHeader = document.getElementById('tabHeader');
      const tabLines = document.getElementById('tabLines');
      const headerPane = document.getElementById('headerSchemaPane');
      const linesPane = document.getElementById('linesSchemaPane');
      function setTab(which) {
        if (which === 'header') {
          headerPane.style.display = '';
          linesPane.style.display = 'none';
          tabHeader.classList.add('btn-primary');
          tabLines.classList.remove('btn-primary');
        } else {
          headerPane.style.display = 'none';
          linesPane.style.display = '';
          tabLines.classList.add('btn-primary');
          tabHeader.classList.remove('btn-primary');
        }
      }
      tabHeader.onclick = () => setTab('header');
      tabLines.onclick = () => setTab('lines');
      setTab('header');

      // Add column buttons
      document.getElementById('addHeaderCol').onclick = () => addHeaderCol();
      document.getElementById('addLineCol').onclick = () => addLineCol();

      // Export buttons
      document.getElementById('exportHeader').onclick = () => exportHeaderCSV(state);
      document.getElementById('exportLines').onclick = () => exportLinesCSV(state);

      // Presets
      document.getElementById('savePreset').onclick = saveCurrentPreset;
      document.getElementById('deletePreset').onclick = deleteCurrentPreset;
      document.getElementById('loadPresetSelect').onchange = (e) => loadPresetByName(e.target.value);
    }

    function closeExportWizard() {
      const modal = document.getElementById('exportWizard');
      modal.classList.add('hidden');
    }

    function initWizardUI() {
      // no-op placeholder if needed later
    }

    function colRowTemplate(data = {}, type = 'header') {
      const id = cryptoRand();
      const name = data.name || '';
      const path = data.path || '';
      const tf = data.tf || 'none';
      const fmt = data.fmt || '';
      return `
        <div class="grid grid-cols-12 gap-2 items-center border border-[var(--border)] rounded-md p-2" data-id="${id}">
          <input class="input col-span-3" placeholder="Column name" value="${escapeHTML(name)}" data-field="name"/>
          <input class="input col-span-5" placeholder="JSON path (e.g. vendor_name or line_items[].quantity)" value="${escapeHTML(path)}" data-field="path"/>
          <select class="input col-span-2" data-field="tf">
            <option value="none"${tf==='none'?' selected':''}>No transform</option>
            <option value="upper"${tf==='upper'?' selected':''}>UPPERCASE</option>
            <option value="lower"${tf==='lower'?' selected':''}>lowercase</option>
            <option value="number"${tf==='number'?' selected':''}>Number format</option>
            <option value="date"${tf==='date'?' selected':''}>Date format</option>
            <option value="prefix"${tf==='prefix'?' selected':''}>Add prefix</option>
            <option value="suffix"${tf==='suffix'?' selected':''}>Add suffix</option>
          </select>
          <input class="input col-span-1" placeholder="fmt" value="${escapeHTML(fmt)}" data-field="fmt" title="For number: decimals; date: format (YYYY-MM-DD); prefix/suffix: text"/>
          <button class="icon-btn col-span-1" title="Remove column" aria-label="Remove column" data-remove-col="${id}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      `;
    }

    function bindColRowEvents(container) {
      container.querySelectorAll('[data-remove-col]').forEach(btn => {
        btn.onclick = () => btn.closest('[data-id]')?.remove();
      });
    }

    function addHeaderCol(data) {
      const container = document.getElementById('headerCols');
      container.insertAdjacentHTML('beforeend', colRowTemplate(data, 'header'));
      bindColRowEvents(container);
    }

    function addLineCol(data) {
      const container = document.getElementById('lineCols');
      container.insertAdjacentHTML('beforeend', colRowTemplate(data, 'line'));
      bindColRowEvents(container);
    }

    function cryptoRand() {
      try { return crypto.getRandomValues(new Uint32Array(1))[0].toString(36); } catch { return String(Math.random()).slice(2); }
    }

    function readSchemaFromUI() {
      function readFrom(containerId) {
        const rows = Array.from(document.getElementById(containerId).children);
        return rows.map(row => {
          const get = (sel) => row.querySelector(`[data-field="${sel}"]`)?.value?.trim() || '';
          return { name: get('name'), path: get('path'), tf: get('tf'), fmt: get('fmt') };
        }).filter(c => c.name && c.path);
      }
      return {
        header: readFrom('headerCols'),
        lines: readFrom('lineCols')
      };
    }

    function applyTransform(val, tf, fmt) {
      if (val == null) val = '';
      switch (tf) {
        case 'upper': return String(val).toUpperCase();
        case 'lower': return String(val).toLowerCase();
        case 'number': {
          const dec = isFinite(parseInt(fmt)) ? parseInt(fmt) : 2;
          const n = Number(val);
          return isFinite(n) ? n.toFixed(dec) : '';
        }
        case 'date': {
          // Simple yyyy-mm-dd normalization
          try {
            const d = new Date(val);
            if (isNaN(d.getTime())) return String(val);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
          } catch { return String(val); }
        }
        case 'prefix': return String(fmt || '') + String(val);
        case 'suffix': return String(val) + String(fmt || '');
        default: return val;
      }
    }

    function getByPath(obj, path, rowIndex, lineIndex) {
      if (!path) return '';
      if (path === '$index') return rowIndex + 1;
      // Support line_items[] notation
      const isArrayPath = path.includes('line_items[]');
      if (isArrayPath) {
        const sub = path.replace('line_items[]', `line_items.${lineIndex}`);
        return simpleJsonPath(obj, sub);
      }
      return simpleJsonPath(obj, path);
    }

    function simpleJsonPath(obj, p) {
      // p like a.b.c or line_items.0.quantity
      try {
        return p.split('.').reduce((acc, key) => {
          if (acc == null) return undefined;
          if (key === '') return acc;
          return acc[key];
        }, obj);
      } catch { return undefined; }
    }

    function exportHeaderCSV(state) {
      const schema = readSchemaFromUI().header;
      const invoices = (state?.invoices) || [];
      const header = schema.map(c => c.name).join(',');
      const lines = [header];
      invoices.forEach((inv, idx) => {
        const row = schema.map(c => {
          const raw = getByPath(inv, c.path, idx, 0);
          const val = applyTransform(raw, c.tf, c.fmt);
          return escapeCsv(val);
        }).join(',');
        lines.push(row);
      });
      const csv = lines.join('\\n');
      downloadCSV(csv, 'Header.csv');
    }

    function exportLinesCSV(state) {
      const schema = readSchemaFromUI().lines;
      const invoices = (state?.invoices) || [];
      const header = schema.map(c => c.name).join(',');
      const lines = [header];
      let fileNum = 1;
      invoices.forEach((inv, invIdx) => {
        const items = Array.isArray(inv.line_items) ? inv.line_items : [];
        items.forEach((_, lineIdx) => {
          const row = schema.map(c => {
            // allow paths to refer to header or lines
            const source = c.path.includes('line_items[]') ? inv : inv;
            const raw = getByPath(inv, c.path, invIdx, lineIdx);
            const val = applyTransform(raw, c.tf, c.fmt);
            return escapeCsv(val);
          }).join(',');
          lines.push(row);
        });
        fileNum += 1;
      });
      const csv = lines.join('\\n');
      downloadCSV(csv, 'LineItems.csv');
    }

    function escapeCsv(v) {
      const s = v == null ? '' : String(v);
      if (s.includes(',') || s.includes('"') || s.includes('\\n')) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }

    // Presets
    function loadPresets() {
      const sel = document.getElementById('loadPresetSelect');
      const list = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]');
      sel.innerHTML = '<option value="">Load preset‚Ä¶</option>' + list.map(p => `<option>${escapeHTML(p.name)}</option>`).join('');
    }
    function saveCurrentPreset() {
      const name = document.getElementById('presetName').value.trim();
      if (!name) return showErrors(['Enter a preset name']);
      const schema = readSchemaFromUI();
      const list = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]');
      const idx = list.findIndex(p => p.name === name);
      if (idx >= 0) list[idx] = { name, schema };
      else list.push({ name, schema });
      localStorage.setItem(PRESETS_KEY, JSON.stringify(list));
      loadPresets();
      showErrors([`Preset "${name}" saved`]);
    }
    function deleteCurrentPreset() {
      const sel = document.getElementById('loadPresetSelect');
      const pick = sel.value;
      if (!pick) return;
      const list = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]');
      const next = list.filter(p => p.name !== pick);
      localStorage.setItem(PRESETS_KEY, JSON.stringify(next));
      // Clear UI if deleting current
      if (document.getElementById('presetName').value.trim() === pick) {
        document.getElementById('headerCols').innerHTML = '';
        document.getElementById('lineCols').innerHTML = '';
        document.getElementById('presetName').value = '';
      }
      loadPresets();
      showErrors([`Preset "${pick}" deleted`]);
    }
    function loadPresetByName(name) {
      if (!name) return;
      const list = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]');
      const found = list.find(p => p.name === name);
      if (!found) return;
      document.getElementById('presetName').value = found.name;
      // Populate UI
      const headerCols = document.getElementById('headerCols');
      const lineCols = document.getElementById('lineCols');
      headerCols.innerHTML = '';
      lineCols.innerHTML = '';
      (found.schema.header || []).forEach(c => addHeaderCol(c));
      (found.schema.lines || []).forEach(c => addLineCol(c));
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Invoice AI initialized');
      processBtn.disabled = true;
    });
  </script>
</body>
</html>
